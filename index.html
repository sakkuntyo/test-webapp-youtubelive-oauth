<!doctype html>
<meta charset="utf-8" />
<title>YouTube Live Chat Viewer/Sender (Static / auto sign-in)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#0b0b10;--panel:#141420;--text:#e8e8ef;--muted:#9aa0a6;--accent:#6ea8fe}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:var(--panel);padding:12px 14px;border-bottom:1px solid #212138}
  header b{margin-right:auto}
  main{display:grid;grid-template-columns:360px 1fr;gap:14px;padding:14px}
  @media (max-width:900px){main{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid #212138;border-radius:12px}
  .sect{padding:12px}
  input,button{background:#1c1c2b;color:var(--text);border:1px solid #2b2b3d;border-radius:8px;padding:8px 10px}
  button{cursor:pointer} button.primary{border-color:#325aa8} button:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap}
  small.muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #314;border-radius:999px;font-size:12px;color:#e7d7ff;background:#271a35}
  #chat{list-style:none;margin:0;padding:10px;max-height:70vh;overflow:auto}
  #chat li{padding:10px 12px;border-bottom:1px solid #212138} #chat li:last-child{border-bottom:none}
  .author{font-weight:600;margin-right:6px} .time{color:var(--muted);font-size:12px;margin-left:6px}
  code{background:#0c0c14;padding:2px 6px;border-radius:6px}
</style>

<header>
  <b>YT Live Chat (Static)</b>
  <span id="who" class="pill" title="Signed-in account" style="display:none"></span>
  <button id="btnSignIn" class="primary">Sign in</button>
  <button id="btnSignOut" style="display:none">Sign out</button>
</header>

<main>
  <section class="card">
    <div class="sect">
      <h3 style="margin:6px 0 4px">Source</h3>
      <div class="row">
        <button id="btnFindActive" title="自チャンネルで現在ライブ中を検索" disabled>Find my active live</button>
        <span id="activeStatus"><small class="muted">no live yet</small></span>
      </div>
      <div class="row">
        <input id="videoId" placeholder="or paste a YouTube video ID (live)" size="36" />
        <button id="btnUseVideo" disabled>Use video ID</button>
      </div>
      <div class="row">
        <input id="chatId" placeholder="or paste a liveChatId directly" size="36" />
        <button id="btnUseChat" disabled>Use liveChatId</button>
      </div>
      <div class="row">
        <button id="btnStart" class="primary" disabled>Start reading</button>
        <button id="btnStop" disabled>Stop</button>
        <small id="stats" class="muted"></small>
      </div>

      <h3 style="margin:14px 0 4px">Send</h3>
      <div class="row">
        <input id="msg" placeholder="type message..." size="28" />
        <button id="btnSend" disabled>Send</button>
        <small class="muted">enter で送信</small>
      </div>

      <details style="margin-top:8px">
        <summary>Debug</summary>
        <pre id="debug" style="max-height:220px; overflow:auto; background:#0c0c14; padding:8px; border-radius:8px"></pre>
      </details>
    </div>
  </section>

  <section class="card">
    <div class="sect">
      <h3 style="margin:6px 0 8px">Live chat</h3>
      <ul id="chat"></ul>
    </div>
  </section>
</main>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
/* ====== CONFIG ====== */
const CLIENT_ID = "157676962507-h1npk0jfactaco75nbei28j2v9bd92io.apps.googleusercontent.com"; // ←あなたのWebアプリ用クライアントIDに差し替え
const SCOPE = "https://www.googleapis.com/auth/youtube.force-ssl";         // 読み書き（送信するため）
const API = "https://www.googleapis.com/youtube/v3";

/* ====== STATE ====== */
let accessToken = null;
let tokenClient = null;
let pollTimer = null;
let nextPageToken = null;
let liveChatId = null;
let messageCount = 0;
let refreshTimer = null;

/* ====== UI helpers ====== */
const $ = s => document.querySelector(s);
const logDebug = (...a)=>{ const el=$("#debug"); el.textContent += a.join(" ")+"\n"; el.scrollTop=el.scrollHeight; };
const setStats = t => $("#stats").textContent = t;
const escapeHtml = s => (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
const addMsg = ({author,text,ts})=>{
  const li=document.createElement("li");
  const when=new Date(ts);
  li.innerHTML = `<span class="author">${escapeHtml(author||"")}</span>
                  <span class="time">${when.toLocaleTimeString()}</span>
                  <div>${escapeHtml(text||"")}</div>`;
  $("#chat").appendChild(li);
  $("#chat").scrollTop=$("#chat").scrollHeight;
};

function setSignedInUI(on){
  $("#btnSignIn").style.display = on ? "none" : "";
  $("#btnSignOut").style.display = on ? "" : "none";
  $("#btnFindActive").disabled = !on;
  $("#btnUseVideo").disabled  = !on;
  $("#btnUseChat").disabled   = !on;
  if(!on){ $("#who").style.display="none"; }
  updateSendButton();
}

function updateSendButton(){
  $("#btnSend").disabled = !(accessToken && liveChatId);
}

/* ====== AUTH ====== */
async function initAuth(){
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPE,
    callback: (resp)=>{} // 呼び出し毎に差し替える
  });

  // 無言サインイン試行（同意済み＆Googleセッションあれば成功）
  trySilentToken().then(async ok=>{
    if(ok){
      setSignedInUI(true);
      await whoAmI().catch(()=>{});
      $("#btnStart").disabled = !liveChatId;
      logDebug("silent auth OK");
    }else{
      setSignedInUI(false);
      logDebug("silent auth failed (needs consent or Google session)");
    }
  });
}

function trySilentToken(){
  return new Promise(resolve=>{
    tokenClient.callback = (resp)=>{
      if(resp?.access_token){ onToken(resp); resolve(true); }
      else resolve(false);
    };
    tokenClient.requestAccessToken({ prompt: '' }); // 無言
  });
}

function interactiveSignIn(){
  tokenClient.callback = (resp)=>{
    if(resp?.access_token){
      onToken(resp);
      setSignedInUI(true);
      whoAmI().catch(()=>{});
      logDebug("interactive consent OK");
    }
  };
  tokenClient.requestAccessToken({ prompt: 'consent' });
}

function onToken(resp){
  accessToken = resp.access_token;
  scheduleTokenRefresh(resp.expires_in);
  $("#btnStart").disabled = !liveChatId;
  $("#btnSignOut").disabled = false;
  updateSendButton();
}

function scheduleTokenRefresh(expiresIn){
  if(refreshTimer) clearTimeout(refreshTimer);
  const sec = (typeof expiresIn==='number' && expiresIn>0) ? expiresIn : 3600;
  const refreshInMs = Math.max(60_000, (sec - 600) * 1000); // 失効10分前に更新
  refreshTimer = setTimeout(()=>{
    tokenClient.callback = (resp)=>{ if(resp?.access_token){ onToken(resp); logDebug("token refreshed"); } };
    tokenClient.requestAccessToken({ prompt: '' });
  }, refreshInMs);
}

function signOut(){
  if(!accessToken) return;
  google.accounts.oauth2.revoke(accessToken, ()=>{
    accessToken=null;
    $("#who").textContent=""; $("#who").style.display="none";
    setSignedInUI(false);
    stopReading();
    if(refreshTimer){ clearTimeout(refreshTimer); refreshTimer=null; }
  });
}

/* ====== ME (UX用表示) ====== */
async function whoAmI(){
  const r = await fetch(`${API}/channels?part=snippet&mine=true`, {
    headers: { Authorization: `Bearer ${accessToken}` }
  });
  if(!r.ok) return;
  const j = await r.json();
  const ch = j.items?.[0];
  if(ch){
    $("#who").textContent = `@${ch.snippet.customUrl || ch.snippet.title}`;
    $("#who").style.display = "";
  }
}

/* ====== FIND LIVE / RESOLVE CHAT ID ====== */
async function findActive(){
  requireAuth();
  $("#activeStatus").innerHTML = `<small class="muted">searching...</small>`;
  try{
    const res = await fetch(`${API}/liveBroadcasts?part=snippet&broadcastStatus=active&mine=true`, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    const j = await res.json();
    const b = j.items?.[0];
    liveChatId = b?.snippet?.liveChatId || null;
    if(liveChatId){
      $("#chatId").value = liveChatId;
      $("#activeStatus").innerHTML = `<small>found liveChatId:</small> <code>${liveChatId}</code>`;
      $("#btnStart").disabled = !accessToken;
    }else{
      $("#activeStatus").innerHTML = `<small class="muted">no active live found</small>`;
    }
  }catch(e){
    $("#activeStatus").innerHTML = `<small class="muted">error</small>`;
    logDebug("findActive error:", e);
  }
  updateSendButton();
}

async function useVideo(){
  requireAuth();
  const vid = $("#videoId").value.trim();
  if(!vid) return alert("Enter a video ID");
  try{
    const r = await fetch(`${API}/videos?part=liveStreamingDetails&id=${encodeURIComponent(vid)}`, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    const j = await r.json();
    liveChatId = j.items?.[0]?.liveStreamingDetails?.activeLiveChatId || null;
    if(!liveChatId) return alert("activeLiveChatId not found (is it live with chat enabled?)");
    $("#chatId").value = liveChatId;
    $("#activeStatus").innerHTML = `<small>from video:</small> <code>${liveChatId}</code>`;
    $("#btnStart").disabled = !accessToken;
  }catch(e){ logDebug("useVideo error:", e); }
  updateSendButton();
}

function useChat(){
  liveChatId = $("#chatId").value.trim() || null;
  if(!liveChatId) return alert("Enter liveChatId");
  $("#btnStart").disabled = !accessToken;
  $("#activeStatus").innerHTML = `<small>chat set:</small> <code>${liveChatId}</code>`;
  updateSendButton();
}

/* ====== POLLING (read) ====== */
function startReading(){
  if(!liveChatId) return alert("No liveChatId");
  $("#btnStart").disabled = true; $("#btnStop").disabled = false;
  nextPageToken = null; messageCount=0; $("#chat").innerHTML=""; setStats("starting…");
  poll();
}

function stopReading(){
  if(pollTimer){ clearTimeout(pollTimer); pollTimer=null; }
  setStats("stopped");
  $("#btnStart").disabled = !liveChatId || !accessToken;
  $("#btnStop").disabled = true;
}

async function poll(){
  try{
    const url = new URL(`${API}/liveChat/messages`);
    url.searchParams.set("part","snippet,authorDetails");
    url.searchParams.set("liveChatId", liveChatId);
    if(nextPageToken) url.searchParams.set("pageToken", nextPageToken);

    const res = await fetch(url, { headers:{ Authorization:`Bearer ${accessToken}` } });
    if(!res.ok){
      const txt = await res.text();
      logDebug("poll error", res.status, txt);
      setStats(`error ${res.status}`);
      pollTimer = setTimeout(poll, 5000);
      return;
    }
    const j = await res.json();
    nextPageToken = j.nextPageToken || null;

    for(const it of (j.items||[])){
      const a = it.authorDetails||{}, s = it.snippet||{};
      if(s.displayMessage){ messageCount++; addMsg({ author:a.displayName, text:s.displayMessage, ts:s.publishedAt }); }
    }
    setStats(`${messageCount} msgs • next in ${j.pollingIntervalMillis ?? 0} ms`);
    const wait = Math.max(1000, j.pollingIntervalMillis ?? 4000);
    pollTimer = setTimeout(poll, wait);
  }catch(e){
    logDebug("poll exception:", e);
    pollTimer = setTimeout(poll, 5000);
  }
}

/* ====== SEND (write) ====== */
async function sendMessage(){
  const text = $("#msg").value.trim();
  if(!text) return;
  if(!(accessToken && liveChatId)) return alert("Sign in and select a live chat first.");

  const body = {
    snippet: {
      liveChatId,
      type: "textMessageEvent",
      textMessageDetails: { messageText: text }
    }
  };

  const res = await fetch(`${API}/liveChat/messages?part=snippet`, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${accessToken}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });

  if(!res.ok){
    const err = await res.json().catch(()=> ({}));
    logDebug("send error", res.status, JSON.stringify(err));
    return;
  }
  $("#msg").value = "";
}

/* ====== utils ====== */
function requireAuth(){ if(!accessToken) throw new Error("Not signed in"); }

/* ====== wire UI ====== */
window.addEventListener("load", initAuth);
$("#btnSignIn").onclick   = interactiveSignIn;
$("#btnSignOut").onclick  = signOut;
$("#btnFindActive").onclick = findActive;
$("#btnUseVideo").onclick   = useVideo;
$("#btnUseChat").onclick    = useChat;
$("#btnStart").onclick      = startReading;
$("#btnStop").onclick       = stopReading;
$("#btnSend").onclick       = sendMessage;
$("#msg").addEventListener("keydown", e => { if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
</script>
