<!doctype html>
<meta charset="utf-8" />
<title>YouTube Live Chat Viewer/Sender (Static / external login support)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#0b0b10;--panel:#141420;--text:#e8e8ef;--muted:#9aa0a6;--accent:#6ea8fe}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:var(--panel);padding:12px 14px;border-bottom:1px solid #212138}
  header b{margin-right:auto}
  main{display:grid;grid-template-columns:360px 1fr;gap:14px;padding:14px}
  @media (max-width:900px){main{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid #212138;border-radius:12px}
  .sect{padding:12px}
  input,button{background:#1c1c2b;color:var(--text);border:1px solid #2b2b3d;border-radius:8px;padding:8px 10px}
  button{cursor:pointer} button.primary{border-color:#325aa8} button:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap}
  small.muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #314;border-radius:999px;font-size:12px;color:#e7d7ff;background:#271a35}
  #chat{list-style:none;margin:0;padding:10px;max-height:70vh;overflow:auto}
  #chat li{padding:10px 12px;border-bottom:1px solid #212138} #chat li:last-child{border-bottom:none}
  .author{font-weight:600;margin-right:6px} .time{color:var(--muted);font-size:12px;margin-left:6px}
  code{background:#0c0c14;padding:2px 6px;border-radius:6px}
  .hint{font-size:12px;color:var(--muted)}
</style>

<header>
  <b>YT Live Chat (Static)</b>
  <span id="who" class="pill" title="Signed-in account" style="display:none"></span>
  <button id="btnSignIn" class="primary">Sign in</button>
  <button id="btnSignOut" style="display:none">Sign out</button>
</header>

<main>
  <section class="card">
    <div class="sect">
      <h3 style="margin:6px 0 4px">Source</h3>
      <div class="row">
        <button id="btnFindActive" title="自チャンネルで現在ライブ中を検索" disabled>Find my active live</button>
        <span id="activeStatus"><small class="muted">no live yet</small></span>
      </div>
      <div class="row">
        <input id="videoId" placeholder="or paste a YouTube video ID (live)" size="36" />
        <button id="btnUseVideo" disabled>Use video ID</button>
      </div>
      <div class="row">
        <input id="chatId" placeholder="or paste a liveChatId directly" size="36" />
        <button id="btnUseChat" disabled>Use liveChatId</button>
      </div>
      <div class="row">
        <button id="btnStart" class="primary" disabled>Start reading</button>
        <button id="btnStop" disabled>Stop</button>
        <small id="stats" class="muted"></small>
      </div>

      <h3 style="margin:14px 0 4px">Send</h3>
      <div class="row">
        <input id="msg" placeholder="type message..." size="28" />
        <button id="btnSend" disabled>Send</button>
        <small class="muted">enter で送信</small>
      </div>

      <!-- ▼ 追加: 外部ブラウザログイン（ペアリング） -->
      <h3 style="margin:14px 0 4px">External login (pairing)</h3>
      <div class="row">
        <button id="btnExtStart" disabled>Start external login</button>
        <button id="btnExtStop" disabled>Stop</button>
        <small id="extStatus" class="muted"></small>
      </div>
      <div id="extBox" style="display:none; margin-top:4px">
        <div class="row">
          <label class="hint">Pair code:</label>
          <input id="extCode" readonly size="8" />
          <a id="extLink" target="_blank" rel="noopener">open link</a>
        </div>
        <div class="row">
          <img id="extQR" alt="QR" style="max-width:160px;background:#fff;padding:6px;border-radius:8px;display:none">
          <small class="hint">スマホでQRを開いてサインインしてください（同一ドメインで <code>?auth=1&code=XXXXXX</code> が開きます）</small>
        </div>
      </div>
      <!-- ▲ 追加ここまで -->

      <details style="margin-top:8px">
        <summary>Debug</summary>
        <pre id="debug" style="max-height:220px; overflow:auto; background:#0c0c14; padding:8px; border-radius:8px"></pre>
      </details>
    </div>
  </section>

  <section class="card">
    <div class="sect">
      <h3 style="margin:6px 0 8px">Live chat</h3>
      <ul id="chat"></ul>
    </div>
  </section>
</main>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
/* =========================
   CONFIG
   -------------------------
   - CLIENT_ID: あなたのWebアプリ用クライアントID
   - PAIR_BASE: 外部ログイン用のペアリングAPIベースURL
       期待するエンドポイント:
         PUT   {PAIR_BASE}/{code}  body: {"access_token":"...", "expires_at": <ms epoch>}
         GET   {PAIR_BASE}/{code}  → 同上JSON（なければ404/204）
         DELETE{PAIR_BASE}/{code}  → ペア中断（任意）
   ========================= */
const CLIENT_ID = "157676962507-h1npk0jfactaco75nbei28j2v9bd92io.apps.googleusercontent.com";
const SCOPE = "https://www.googleapis.com/auth/youtube.force-ssl";
const API = "https://www.googleapis.com/youtube/v3";
const PAIR_BASE = ""; // 例: "https://your-worker.example.com/pair"（空なら機能OFF）

/* ====== MODE: 通常 or 認証ヘルパー ====== */
const urlp = new URL(location.href);
const isAuthMode = urlp.searchParams.get("auth") === "1" || location.hash.includes("auth");

/* ====== STATE ====== */
let accessToken = null;
let tokenClient = null;
let pollTimer = null;
let nextPageToken = null;
let liveChatId = null;
let messageCount = 0;
let refreshTimer = null;

// pairing state
let pairCode = null;
let pairPollTimer = null;
let pairKeepTimer = null;

/* ====== UI helpers ====== */
const $ = s => document.querySelector(s);
const logDebug = (...a)=>{ const el=$("#debug"); if(el){ el.textContent += a.join(" ")+"\n"; el.scrollTop=el.scrollHeight; } };
const setStats = t => { const el=$("#stats"); if(el) el.textContent = t; };
const escapeHtml = s => (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
const addMsg = ({author,text,ts})=>{
  const li=document.createElement("li");
  const when=new Date(ts);
  li.innerHTML = `<span class="author">${escapeHtml(author||"")}</span>
                  <span class="time">${when.toLocaleTimeString()}</span>
                  <div>${escapeHtml(text||"")}</div>`;
  const chat=$("#chat"); if(chat){ chat.appendChild(li); chat.scrollTop=chat.scrollHeight; }
};

function setSignedInUI(on){
  if($("#btnSignIn")) $("#btnSignIn").style.display = on ? "none" : "";
  if($("#btnSignOut")) $("#btnSignOut").style.display = on ? "" : "none";
  if($("#btnFindActive")) $("#btnFindActive").disabled = !on;
  if($("#btnUseVideo"))  $("#btnUseVideo").disabled  = !on;
  if($("#btnUseChat"))   $("#btnUseChat").disabled   = !on;
  if(!on && $("#who")) { $("#who").style.display="none"; }
  updateSendButton();
}

function updateSendButton(){
  if($("#btnSend")) $("#btnSend").disabled = !(accessToken && liveChatId);
}

/* ====== AUTH (GIS) ====== */
function initAuth(){
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPE,
    callback: (resp)=>{} // 呼び出し毎に差し替える
  });

  if (isAuthMode) {
    // 認証ヘルパーは無言サインインは試さない（ユーザー操作で開始）
    setupAuthHelperUI();
    return;
  }

  // 通常モード：無言サインイン（同意済み＆Googleセッションがあれば入る）
  trySilentToken().then(async ok=>{
    if(ok){
      setSignedInUI(true);
      await whoAmI().catch(()=>{});
      $("#btnStart").disabled = !liveChatId;
      logDebug("silent auth OK");
    }else{
      setSignedInUI(false);
      logDebug("silent auth failed (needs consent or Google session)");
    }
  });

  // 外部ログインUIの有効化
  if (PAIR_BASE) {
    $("#btnExtStart").disabled = false;
    $("#btnExtStop").disabled = true;
    $("#extStatus").textContent = "ready";
  } else {
    $("#extStatus").textContent = "set PAIR_BASE to enable external login";
  }
}

function trySilentToken(){
  return new Promise(resolve=>{
    tokenClient.callback = (resp)=>{
      if(resp?.access_token){ onToken(resp); resolve(true); }
      else resolve(false);
    };
    tokenClient.requestAccessToken({ prompt: '' }); // 無言
  });
}

function interactiveSignIn(){
  tokenClient.callback = (resp)=>{
    if(resp?.access_token){
      onToken(resp);
      setSignedInUI(true);
      whoAmI().catch(()=>{});
      logDebug("interactive consent OK");
    }
  };
  tokenClient.requestAccessToken({ prompt: 'consent' });
}

function onToken(resp){
  accessToken = resp.access_token;
  scheduleTokenRefresh(resp.expires_in);
  if($("#btnStart")) $("#btnStart").disabled = !liveChatId;
  if($("#btnSignOut")) $("#btnSignOut").disabled = false;
  updateSendButton();

  // 認証ヘルパーモードでは、取得のたびにPAIRへアップロード
  if (isAuthMode && pairCode) {
    pairPut(pairCode, accessToken, resp.expires_in).catch(e=>logDebug("pair PUT fail:", e));
  }
}

function scheduleTokenRefresh(expiresIn){
  if(refreshTimer) clearTimeout(refreshTimer);
  const sec = (typeof expiresIn==='number' && expiresIn>0) ? expiresIn : 3600;
  const refreshInMs = Math.max(60_000, (sec - 600) * 1000); // 失効10分前
  refreshTimer = setTimeout(()=>{
    tokenClient.callback = (resp)=>{ if(resp?.access_token){ onToken(resp); logDebug("token refreshed"); } };
    tokenClient.requestAccessToken({ prompt: '' });
  }, refreshInMs);
}

function signOut(){
  if(!accessToken) return;
  google.accounts.oauth2.revoke(accessToken, ()=>{
    accessToken=null;
    if($("#who")) { $("#who").textContent=""; $("#who").style.display="none"; }
    setSignedInUI(false);
    stopReading();
    if(refreshTimer){ clearTimeout(refreshTimer); refreshTimer=null; }
  });
}

/* ====== ME (UX用表示) ====== */
async function whoAmI(){
  const r = await fetch(`${API}/channels?part=snippet&mine=true`, {
    headers: { Authorization: `Bearer ${accessToken}` }
  });
  if(!r.ok) return;
  const j = await r.json();
  const ch = j.items?.[0];
  if(ch && $("#who")){
    $("#who").textContent = `@${ch.snippet.customUrl || ch.snippet.title}`;
    $("#who").style.display = "";
  }
}

/* ====== FIND LIVE / RESOLVE CHAT ID ====== */
async function findActive(){
  requireAuth();
  if($("#activeStatus")) $("#activeStatus").innerHTML = `<small class="muted">searching...</small>`;
  try{
    const res = await fetch(`${API}/liveBroadcasts?part=snippet&broadcastStatus=active&mine=true`, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    const j = await res.json();
    const b = j.items?.[0];
    liveChatId = b?.snippet?.liveChatId || null;
    if(liveChatId){
      if($("#chatId")) $("#chatId").value = liveChatId;
      if($("#activeStatus")) $("#activeStatus").innerHTML = `<small>found liveChatId:</small> <code>${liveChatId}</code>`;
      if($("#btnStart")) $("#btnStart").disabled = !accessToken;
    }else{
      if($("#activeStatus")) $("#activeStatus").innerHTML = `<small class="muted">no active live found</small>`;
    }
  }catch(e){
    if($("#activeStatus")) $("#activeStatus").innerHTML = `<small class="muted">error</small>`;
    logDebug("findActive error:", e);
  }
  updateSendButton();
}

async function useVideo(){
  requireAuth();
  const vid = $("#videoId").value.trim();
  if(!vid) return alert("Enter a video ID");
  try{
    const r = await fetch(`${API}/videos?part=liveStreamingDetails&id=${encodeURIComponent(vid)}`, {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    const j = await resToJson(r);
    liveChatId = j.items?.[0]?.liveStreamingDetails?.activeLiveChatId || null;
    if(!liveChatId) return alert("activeLiveChatId not found (is it live with chat enabled?)");
    if($("#chatId")) $("#chatId").value = liveChatId;
    if($("#activeStatus")) $("#activeStatus").innerHTML = `<small>from video:</small> <code>${liveChatId}</code>`;
    if($("#btnStart")) $("#btnStart").disabled = !accessToken;
  }catch(e){ logDebug("useVideo error:", e); }
  updateSendButton();
}

function useChat(){
  liveChatId = $("#chatId").value.trim() || null;
  if(!liveChatId) return alert("Enter liveChatId");
  if($("#btnStart")) $("#btnStart").disabled = !accessToken;
  if($("#activeStatus")) $("#activeStatus").innerHTML = `<small>chat set:</small> <code>${liveChatId}</code>`;
  updateSendButton();
}

/* ====== POLLING (read) ====== */
function startReading(){
  if(!liveChatId) return alert("No liveChatId");
  if($("#btnStart")) $("#btnStart").disabled = true;
  if($("#btnStop"))  $("#btnStop").disabled = false;
  nextPageToken = null; messageCount=0; const chat=$("#chat"); if(chat) chat.innerHTML="";
  setStats("starting…");
  poll();
}

function stopReading(){
  if(pollTimer){ clearTimeout(pollTimer); pollTimer=null; }
  setStats("stopped");
  if($("#btnStart")) $("#btnStart").disabled = !liveChatId || !accessToken;
  if($("#btnStop"))  $("#btnStop").disabled = true;
}

async function poll(){
  try{
    const url = new URL(`${API}/liveChat/messages`);
    url.searchParams.set("part","snippet,authorDetails");
    url.searchParams.set("liveChatId", liveChatId);
    if(nextPageToken) url.searchParams.set("pageToken", nextPageToken);

    const res = await fetch(url, { headers:{ Authorization:`Bearer ${accessToken}` } });
    if(!res.ok){
      const txt = await res.text();
      logDebug("poll error", res.status, txt);
      setStats(`error ${res.status}`);
      pollTimer = setTimeout(poll, 5000);
      return;
    }
    const j = await res.json();
    nextPageToken = j.nextPageToken || null;

    for(const it of (j.items||[])){
      const a = it.authorDetails||{}, s = it.snippet||{};
      if(s.displayMessage){ messageCount++; addMsg({ author:a.displayName, text:s.displayMessage, ts:s.publishedAt }); }
    }
    setStats(`${messageCount} msgs • next in ${j.pollingIntervalMillis ?? 0} ms`);
    const wait = Math.max(1000, j.pollingIntervalMillis ?? 4000);
    pollTimer = setTimeout(poll, wait);
  }catch(e){
    logDebug("poll exception:", e);
    pollTimer = setTimeout(poll, 5000);
  }
}

/* ====== SEND (write) ====== */
async function sendMessage(){
  const text = $("#msg").value.trim();
  if(!text) return;
  if(!(accessToken && liveChatId)) return alert("Sign in and select a live chat first.");

  const body = {
    snippet: {
      liveChatId,
      type: "textMessageEvent",
      textMessageDetails: { messageText: text }
    }
  };

  const res = await fetch(`${API}/liveChat/messages?part=snippet`, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${accessToken}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });

  if(!res.ok){
    const err = await res.json().catch(()=> ({}));
    logDebug("send error", res.status, JSON.stringify(err));
    return;
  }
  $("#msg").value = "";
}

/* ====== External login (pairing) ====== */
function rndCode(len=6){
  const s="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // 見やすい文字
  let out=""; for(let i=0;i<len;i++) out+=s[(Math.random()*s.length)|0]; return out;
}
async function pairPut(code, token, expiresIn){
  const expires_at = Date.now() + ((typeof expiresIn==='number'&&expiresIn>0?expiresIn:3600)*1000);
  const res = await fetch(`${PAIR_BASE}/${encodeURIComponent(code)}`, {
    method:"PUT", headers:{ "content-type":"application/json" },
    body: JSON.stringify({ access_token: token, expires_at })
  });
  if(!res.ok) throw new Error(`pair PUT ${res.status}`);
  return { expires_at };
}
async function pairGet(code){
  const res = await fetch(`${PAIR_BASE}/${encodeURIComponent(code)}?t=${Date.now()}`, { cache:"no-store" });
  if(!res.ok) throw new Error(`pair GET ${res.status}`);
  return res.json();
}
async function pairDelete(code){
  try{ await fetch(`${PAIR_BASE}/${encodeURIComponent(code)}`, { method:"DELETE" }); }catch{}
}

function extStart(){
  if(!PAIR_BASE){ alert("PAIR_BASE is not set."); return; }
  pairCode = rndCode();
  const link = `${location.origin}${location.pathname}?auth=1&code=${pairCode}`;
  $("#extCode").value = pairCode;
  $("#extLink").href = link;
  $("#extLink").textContent = "open link";
  $("#extQR").src = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(link)}`;
  $("#extQR").style.display = "";
  $("#extBox").style.display = "";
  $("#extStatus").textContent = "waiting for token…";
  $("#btnExtStart").disabled = true;
  $("#btnExtStop").disabled  = false;

  // 5秒間隔でトークン取得（取得後は30秒間隔で差し替え監視）
  if(pairPollTimer) clearInterval(pairPollTimer);
  pairPollTimer = setInterval(async ()=>{
    try{
      const j = await pairGet(pairCode);
      if(j && j.access_token){
        onTokenPair(j.access_token, j.expires_at);
      }
    }catch(e){ /* まだ未配置 */ }
  }, 5000);
}

function extStop(){
  if(pairPollTimer) { clearInterval(pairPollTimer); pairPollTimer=null; }
  if(pairKeepTimer) { clearTimeout(pairKeepTimer); pairKeepTimer=null; }
  if(pairCode){ pairDelete(pairCode); }
  pairCode = null;
  $("#extBox").style.display = "none";
  $("#btnExtStart").disabled = !PAIR_BASE;
  $("#btnExtStop").disabled  = true;
  $("#extStatus").textContent = PAIR_BASE ? "ready" : "set PAIR_BASE";
}

function onTokenPair(token, expires_at){
  accessToken = token;
  setSignedInUI(true);
  updateSendButton();
  whoAmI().catch(()=>{});
  $("#extStatus").textContent = `token ok (exp ${new Date(expires_at).toLocaleTimeString()})`;

  // 失効10分前に強制再チェック（通常は30秒間隔ポーリングで更新され続ける）
  if(pairKeepTimer) clearTimeout(pairKeepTimer);
  const ms = Math.max(60_000, (expires_at - Date.now()) - 10*60*1000);
  pairKeepTimer = setTimeout(async ()=>{
    try{
      const j = await pairGet(pairCode);
      if(j && j.access_token) onTokenPair(j.access_token, j.expires_at);
    }catch(e){ logDebug("pair refresh fail:", e); }
  }, ms);
}

/* ====== 認証ヘルパーUI（?auth=1） ====== */
function setupAuthHelperUI(){
  // 通常UIを隠してヘッダだけ活かす
  const m = document.querySelector("main"); if(m) m.style.display = "none";
  const who = $("#who"); if(who) who.style.display="none";
  const b = document.querySelector("header b"); if(b) b.textContent = "YT Live Chat – Auth Helper";

  // 画面を簡易構成で追加
  const wrap = document.createElement("section");
  wrap.className = "card";
  wrap.innerHTML = `
    <div class="sect">
      <h3 style="margin:6px 0 4px">External login (Auth helper)</h3>
      <div class="row">
        <label class="hint">Pair code:</label>
        <input id="authCode" size="8" />
        <button id="authSignIn" class="primary">Sign in</button>
        <button id="authSignOut" style="display:none">Sign out</button>
      </div>
      <div class="row">
        <small id="authStatus" class="muted">enter code and sign in</small>
      </div>
      <details style="margin-top:8px"><summary>Debug</summary>
        <pre id="debug" style="max-height:220px; overflow:auto; background:#0c0c14; padding:8px; border-radius:8px"></pre>
      </details>
    </div>`;
  document.body.appendChild(wrap);

  // URLの code を自動セット
  const qCode = urlp.searchParams.get("code");
  if(qCode) { $("#authCode").value = qCode; }

  // ボタン紐づけ
  $("#authSignIn").onclick = ()=>{
    const c = $("#authCode").value.trim();
    if(!c) return alert("Enter pair code");
    pairCode = c;
    $("#authStatus").textContent = "signing in…";
    tokenClient.callback = (resp)=>{
      if(resp?.access_token){
        onToken(resp); // これが pairPut も呼ぶ（auth mode + pairCode）
        $("#authStatus").textContent = "signed in – token posted";
        $("#authSignIn").style.display = "none";
        $("#authSignOut").style.display = "";
      }
    };
    tokenClient.requestAccessToken({ prompt: 'consent' });
  };

  $("#authSignOut").onclick = ()=>{
    if(refreshTimer){ clearTimeout(refreshTimer); refreshTimer=null; }
    if(accessToken){
      google.accounts.oauth2.revoke(accessToken, ()=>{});
      accessToken=null;
    }
    pairDelete(pairCode);
    $("#authStatus").textContent = "signed out";
    $("#authSignOut").style.display = "none";
    $("#authSignIn").style.display = "";
  };
}

/* ====== utils ====== */
async function resToJson(r){ const t=await r.text(); try{return t?JSON.parse(t):{};}catch{return{};} }
function requireAuth(){ if(!accessToken) throw new Error("Not signed in"); }

/* ====== wire UI ====== */
window.addEventListener("load", ()=>{
  if(!window.google || !google.accounts || !google.accounts.oauth2){
    // GISの読み込み待ち
    const t = setInterval(()=>{ if(google?.accounts?.oauth2){ clearInterval(t); initAuth(); } }, 50);
  }else{
    initAuth();
  }
});

if($("#btnSignIn"))   $("#btnSignIn").onclick   = interactiveSignIn;
if($("#btnSignOut"))  $("#btnSignOut").onclick  = signOut;
if($("#btnFindActive")) $("#btnFindActive").onclick = findActive;
if($("#btnUseVideo"))   $("#btnUseVideo").onclick   = useVideo;
if($("#btnUseChat"))    $("#btnUseChat").onclick    = useChat;
if($("#btnStart"))      $("#btnStart").onclick      = startReadi
